# HOPG X線分光器データ解析システム

HOPG（Highly Ordered Pyrolytic Graphite）を用いたX線分光測定データの解析とキャリブレーションを行うPythonプログラム集です。

## 概要

このプロジェクトは、レーザー核融合実験におけるX線エネルギー測定において、HOPGの回折を利用したX線分光器のデータ処理を自動化するためのツール群です。IP（Imaging Plate）で取得した位置-強度データをエネルギー-絶対フォトン数密度スペクトラムに変換します。

## 主要機能

- **自動エネルギー校正**: 既知の基準線を用いた自動キャリブレーション
- **対話的キャリブレーション**: GUIによる基準線位置の手動選択・微調整
- **時間遅延自動計算**: ファイル名とWebデータベースから自動的に時間遅延を算出
- **フィルター補正**: ベリリウムとポリエチレンフィルターの透過率補正
- **グラフ出力**: 高品質なPDFグラフの自動生成
- **データ保存**: CSV形式でのスペクトラムデータ出力

## ファイル構成

```
hopg2spectrum/
├── energy_conversion_HOPG.py              # メインの解析プログラム
├── energy_conversion_HOPG_calibration.py  # キャリブレーション専用プログラム
├── filter/                                # フィルター透過率データ
│   ├── Be_500um_transmittance.dat         # ベリリウムフィルター (500μm)
│   └── CH2_50um_transmittance.dat         # ポリエチレンフィルター (50μm)
├── profile/                               # IPスキャンデータ置き場
│   └── *.csv                              # 実験データファイル
├── data/                                  # 解析結果出力先
│   ├── *.csv                              # 絶対フォトン数スペクトラムデータ
│   └── *.pdf                              # スペクトラムグラフ
└── README.md                              # このファイル
```

## 必要なライブラリ

```bash
pip install numpy scipy matplotlib tkinter requests beautifulsoup4
```

## 使用方法

### 1. 通常の解析（energy_conversion_HOPG.py）

既存のキャリブレーションパラメータを使用して迅速に解析を実行：

```bash
# 基本的な使用法
python energy_conversion_HOPG.py

# 時間遅延を手動指定（23分の場合）
python energy_conversion_HOPG.py -t 23

# インタラクティブキャリブレーションモード
python energy_conversion_HOPG.py -c
```

**動作手順:**
1. GUIでIPスキャンデータファイル（CSVファイル）を選択
2. ショット番号と時間遅延を自動計算（または手動入力）
3. エネルギー変換とフィルター補正を実行
4. 結果をCSVファイルとPDFグラフで出力

### 2. キャリブレーション（energy_conversion_HOPG_calibration.py）

新しいキャリブレーションパラメータを設定：

```bash
# キャリブレーション実行
python energy_conversion_HOPG_calibration.py

# 時間遅延を手動指定
python energy_conversion_HOPG_calibration.py -t 25
```

**動作手順:**
1. IPスキャンデータファイルを選択
2. グラフ上で2つの基準線位置を対話的に選択
3. ドラッグによる位置の微調整が可能
4. 新しいキャリブレーションパラメータを計算
5. メインプログラムのパラメータを自動更新

## データファイル形式

### 入力データ（IPスキャンデータ）
- ファイル名形式: `YYMMDD_GXXXXX_HOPG_HHMM.csv`
  - `YYMMDD`: 測定日
  - `GXXXXX`: ショット番号
  - `HHMM`: IP読み取り時刻
- CSV形式: `位置[cm], 強度[PSL]`

### 出力データ（絶対フォトン数スペクトラム）
- ファイル名: `HOPG_GXXXXX.csv`
- CSV形式: `エネルギー[keV], 絶対フォトン数密度[photons/keV]`

## 技術仕様

### キャリブレーション方式
- **基準エネルギー**: He-α線 (8.048 keV) と Li-α線 (8.391 keV)
- **回折条件**: HOPG (002) 反射
- **格子間隔**: d = 3.357 Å

### 補正処理
- **時間減衰補正**: IP感度の時間依存性を考慮
- **エネルギー応答補正**: IPのエネルギー応答特性を補正
- **フィルター透過率補正**: ベリリウムとポリエチレンフィルターの影響を除去
- **結晶反射率補正**: HOPG結晶の反射率を考慮

### 自動化機能
- **時間遅延自動計算**: ファイル名から読み取り時刻を抽出し、Webデータベースからショット時刻を取得
- **レーザータイプ自動判定**: ショット番号からGXII/LFEXレーザーを自動判別
- **ディレクトリ自動作成**: 出力ディレクトリが存在しない場合は自動作成

## 対話的機能

### キャリブレーション位置選択
- グラフ上でのクリックによる基準線位置選択
- ドラッグによる位置の微調整機能
- リアルタイムでの位置表示とパラメータ更新

### ファイル選択
- 初期ディレクトリが`profile/`フォルダに設定
- CSVファイルの自動フィルタリング
- GUIによる直感的なファイル選択

## エラーハンドリング

- **インタラクティブモード失敗時**: 自動的に最大値位置をフォールバック選択
- **Web接続エラー**: 手動での時間遅延入力に切り替え
- **ファイル読み込みエラー**: エラーメッセージの表示と適切な処理継続

## 開発履歴

- 2024年8月: 初期バージョン開発
- 2024年8月: 時間単位統一（分ベース）
- 2024年8月: 自動ディレクトリ作成機能追加
- 2024年8月: 対話的キャリブレーション機能追加
- 2024年8月: コードリファクタリングと機能分離

## ライセンス

研究用途での利用を想定しています。商用利用については事前にご相談ください。

## 作者

大阪大学レーザー科学研究所
瀧澤龍之介

## 注意事項

- プログラム実行には安定したインターネット接続が必要です（ショット時刻の自動取得のため）
- IPスキャンデータは指定された形式で保存してください
- キャリブレーション後は必ずテストデータで動作確認を行ってください
